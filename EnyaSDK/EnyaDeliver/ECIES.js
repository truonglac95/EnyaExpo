"use strict";

/*

This is a heavily modified version of eccrypto's browser.js
rewritten to use forge random number generator
and remove requirement for node crypto and subtle,
as well as other packages

Jan Liphardt
jan@blockdoc.com
version 0.1 July 2, 2019

*/

var EC = require("elliptic").ec;
var ec = new EC("secp256k1");
var Buffer = require('buffer/').Buffer;
var forge = require('node-forge');

const EC_GROUP_ORDER = Buffer.from('fffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141', 'hex');
const ZERO32 = Buffer.alloc(32, 0);

var _0x5b6e=['\x63\x72\x65\x61\x74\x65\x42\x75\x66\x66\x65\x72','\x72\x61\x77','\x66\x72\x6f\x6d','\x67\x65\x74\x42\x79\x74\x65\x73','\x62\x69\x6e\x61\x72\x79','\x73\x68\x61\x35\x31\x32','\x63\x72\x65\x61\x74\x65','\x75\x70\x64\x61\x74\x65','\x74\x6f\x53\x74\x72\x69\x6e\x67','\x64\x69\x67\x65\x73\x74','\x68\x6d\x61\x63','\x73\x74\x61\x72\x74','\x73\x68\x61\x32\x35\x36','\x67\x65\x6e\x65\x72\x61\x74\x65\x50\x72\x69\x76\x61\x74\x65','\x67\x65\x74\x50\x75\x62\x6c\x69\x63','\x42\x61\x64\x20\x70\x72\x69\x76\x61\x74\x65\x20\x6b\x65\x79','\x6b\x65\x79\x46\x72\x6f\x6d\x50\x72\x69\x76\x61\x74\x65','\x61\x72\x72','\x67\x65\x74\x50\x75\x62\x6c\x69\x63\x43\x6f\x6d\x70\x72\x65\x73\x73\x65\x64','\x73\x69\x67\x6e','\x4d\x65\x73\x73\x61\x67\x65\x20\x69\x73\x20\x74\x6f\x6f\x20\x6c\x6f\x6e\x67','\x74\x6f\x44\x45\x52','\x76\x65\x72\x69\x66\x79','\x42\x61\x64\x20\x70\x75\x62\x6c\x69\x63\x20\x6b\x65\x79','\x42\x61\x64\x20\x73\x69\x67\x6e\x61\x74\x75\x72\x65','\x64\x65\x72\x69\x76\x65','\x69\x73\x42\x75\x66\x66\x65\x72','\x42\x61\x64\x20\x70\x72\x69\x76\x61\x74\x65\x20\x6b\x65\x79\x20\x31','\x42\x61\x64\x20\x70\x75\x62\x6c\x69\x63\x20\x6b\x65\x79\x20\x32','\x42\x61\x64\x20\x70\x72\x69\x76\x61\x74\x65\x20\x6b\x65\x79\x20\x33','\x42\x61\x64\x20\x70\x75\x62\x6c\x69\x63\x20\x6b\x65\x79\x20\x36','\x42\x61\x64\x20\x70\x75\x62\x6c\x69\x63\x20\x6b\x65\x79\x20\x37','\x6b\x65\x79\x46\x72\x6f\x6d\x50\x75\x62\x6c\x69\x63','\x74\x6f\x41\x72\x72\x61\x79','\x65\x6e\x63\x72\x79\x70\x74','\x65\x70\x68\x65\x6d\x50\x72\x69\x76\x61\x74\x65\x4b\x65\x79','\x74\x68\x65\x6e','\x73\x6c\x69\x63\x65','\x63\x72\x65\x61\x74\x65\x43\x69\x70\x68\x65\x72','\x41\x45\x53\x2d\x43\x42\x43','\x66\x69\x6e\x69\x73\x68','\x64\x61\x74\x61','\x63\x6f\x6e\x63\x61\x74','\x65\x70\x68\x65\x6d\x50\x75\x62\x6c\x69\x63\x4b\x65\x79','\x63\x69\x70\x68\x65\x72\x74\x65\x78\x74','\x6d\x61\x63','\x63\x72\x65\x61\x74\x65\x44\x65\x63\x69\x70\x68\x65\x72','\x6f\x75\x74\x70\x75\x74','\x41\x73\x73\x65\x72\x74\x69\x6f\x6e\x20\x66\x61\x69\x6c\x65\x64','\x6c\x65\x6e\x67\x74\x68','\x63\x6f\x6d\x70\x61\x72\x65','\x72\x61\x6e\x64\x6f\x6d','\x67\x65\x74\x42\x79\x74\x65\x73\x53\x79\x6e\x63','\x75\x74\x69\x6c'];(function(_0x40cdbf,_0x1e3783){var _0x3dce17=function(_0x345e28){while(--_0x345e28){_0x40cdbf['push'](_0x40cdbf['shift']());}};_0x3dce17(++_0x1e3783);}(_0x5b6e,0x1e0));var _0xd8d8=function(_0x40cdbf,_0x1e3783){_0x40cdbf=_0x40cdbf-0x0;var _0x3dce17=_0x5b6e[_0x40cdbf];return _0x3dce17;};function assert(_0x1e3783,_0x3dce17){if(!_0x1e3783){throw new Error(_0x3dce17||_0xd8d8('0x0'));}}function isScalar(_0x55ed3a){return Buffer['\x69\x73\x42\x75\x66\x66\x65\x72'](_0x55ed3a)&&_0x55ed3a[_0xd8d8('0x1')]===0x20;}function isValidPrivateKey(_0x5c4fa8){if(!isScalar(_0x5c4fa8)){return![];}return _0x5c4fa8[_0xd8d8('0x2')](ZERO32)>0x0&&_0x5c4fa8[_0xd8d8('0x2')](EC_GROUP_ORDER)<0x0;}function equalConstTime(_0x1707de,_0xb3ac1e){if(_0x1707de[_0xd8d8('0x1')]!==_0xb3ac1e['\x6c\x65\x6e\x67\x74\x68']){return![];}var _0x33ca32=0x0;for(var _0x31263a=0x0;_0x31263a<_0x1707de[_0xd8d8('0x1')];_0x31263a++){_0x33ca32|=_0x1707de[_0x31263a]^_0xb3ac1e[_0x31263a];}return _0x33ca32===0x0;}function randomBytes(_0x2638b4){var _0x5466dd=forge[_0xd8d8('0x3')][_0xd8d8('0x4')](_0x2638b4);var _0x28816c=forge[_0xd8d8('0x5')][_0xd8d8('0x6')](_0x5466dd,_0xd8d8('0x7'));return Buffer[_0xd8d8('0x8')](_0x28816c[_0xd8d8('0x9')](),_0xd8d8('0xa'));}function sha512(_0x3679bf){return new Promise(function(_0x4c3124){var _0x40c361=forge['\x6d\x64'][_0xd8d8('0xb')][_0xd8d8('0xc')]();var _0x11a304=Buffer[_0xd8d8('0x8')](_0x40c361[_0xd8d8('0xd')](_0x3679bf[_0xd8d8('0xe')](_0xd8d8('0xa')))[_0xd8d8('0xf')]()[_0xd8d8('0x9')](),_0xd8d8('0xa'));_0x4c3124(new Uint8Array(_0x11a304));});}function hmacSha256Sign(_0x546071,_0x19c8f8){return new Promise(function(_0x45a122){var _0x1a81f6=forge[_0xd8d8('0x10')][_0xd8d8('0xc')]();_0x1a81f6[_0xd8d8('0x11')](_0xd8d8('0x12'),_0x546071[_0xd8d8('0xe')](_0xd8d8('0xa')));_0x1a81f6[_0xd8d8('0xd')](_0x19c8f8[_0xd8d8('0xe')](_0xd8d8('0xa')));var _0x562b56=Buffer[_0xd8d8('0x8')](_0x1a81f6['\x64\x69\x67\x65\x73\x74']()[_0xd8d8('0x9')](),_0xd8d8('0xa'));_0x45a122(_0x562b56);});}function hmacSha256Verify(_0x269a05,_0x235a53,_0x15e9d5){return new Promise(function(_0x5f0dd5){var _0x49b5f6=forge[_0xd8d8('0x10')][_0xd8d8('0xc')]();_0x49b5f6[_0xd8d8('0x11')](_0xd8d8('0x12'),_0x269a05[_0xd8d8('0xe')]('\x62\x69\x6e\x61\x72\x79'));_0x49b5f6['\x75\x70\x64\x61\x74\x65'](_0x235a53[_0xd8d8('0xe')](_0xd8d8('0xa')));var _0x56bc05=Buffer[_0xd8d8('0x8')](_0x49b5f6['\x64\x69\x67\x65\x73\x74']()['\x67\x65\x74\x42\x79\x74\x65\x73'](),_0xd8d8('0xa'));_0x5f0dd5(equalConstTime(_0x56bc05,_0x15e9d5));});}exports[_0xd8d8('0x13')]=function(){var _0x3701bc=randomBytes(0x20);while(!isValidPrivateKey(_0x3701bc)){_0x3701bc=randomBytes(0x20);}return _0x3701bc;};var getPublic=exports[_0xd8d8('0x14')]=function(_0x23116b){assert(_0x23116b[_0xd8d8('0x1')]===0x20,'\x42\x61\x64\x20\x70\x72\x69\x76\x61\x74\x65\x20\x6b\x65\x79');assert(isValidPrivateKey(_0x23116b),_0xd8d8('0x15'));return Buffer[_0xd8d8('0x8')](ec[_0xd8d8('0x16')](_0x23116b)[_0xd8d8('0x14')](_0xd8d8('0x17')));};var getPublicCompressed=exports[_0xd8d8('0x18')]=function(_0x216ea4){assert(_0x216ea4['\x6c\x65\x6e\x67\x74\x68']===0x20,_0xd8d8('0x15'));assert(isValidPrivateKey(_0x216ea4),_0xd8d8('0x15'));let _0x8657e5=!![];return Buffer[_0xd8d8('0x8')](ec[_0xd8d8('0x16')](_0x216ea4)['\x67\x65\x74\x50\x75\x62\x6c\x69\x63'](_0x8657e5,_0xd8d8('0x17')));};exports[_0xd8d8('0x19')]=function(_0x390181,_0x528840){return new Promise(function(_0x2b419c){assert(_0x390181['\x6c\x65\x6e\x67\x74\x68']===0x20,'\x42\x61\x64\x20\x70\x72\x69\x76\x61\x74\x65\x20\x6b\x65\x79');assert(isValidPrivateKey(_0x390181),_0xd8d8('0x15'));assert(_0x528840[_0xd8d8('0x1')]>0x0,'\x4d\x65\x73\x73\x61\x67\x65\x20\x73\x68\x6f\x75\x6c\x64\x20\x6e\x6f\x74\x20\x62\x65\x20\x65\x6d\x70\x74\x79');assert(_0x528840[_0xd8d8('0x1')]<=0x20,_0xd8d8('0x1a'));_0x2b419c(Buffer[_0xd8d8('0x8')](ec['\x73\x69\x67\x6e'](_0x528840,_0x390181,{'\x63\x61\x6e\x6f\x6e\x69\x63\x61\x6c':!![]})[_0xd8d8('0x1b')]()));});};exports[_0xd8d8('0x1c')]=function(_0x4544e7,_0x32f31d,_0x531df7){return new Promise(function(_0x3e7bd9,_0x31ef91){assert(_0x4544e7[_0xd8d8('0x1')]===0x41||_0x4544e7[_0xd8d8('0x1')]===0x21,_0xd8d8('0x1d'));if(_0x4544e7[_0xd8d8('0x1')]===0x41){assert(_0x4544e7[0x0]===0x4,_0xd8d8('0x1d'));}if(_0x4544e7[_0xd8d8('0x1')]===0x21){assert(_0x4544e7[0x0]===0x2||_0x4544e7[0x0]===0x3,'\x42\x61\x64\x20\x70\x75\x62\x6c\x69\x63\x20\x6b\x65\x79');}assert(_0x32f31d[_0xd8d8('0x1')]>0x0,'\x4d\x65\x73\x73\x61\x67\x65\x20\x73\x68\x6f\x75\x6c\x64\x20\x6e\x6f\x74\x20\x62\x65\x20\x65\x6d\x70\x74\x79');assert(_0x32f31d['\x6c\x65\x6e\x67\x74\x68']<=0x20,_0xd8d8('0x1a'));if(ec[_0xd8d8('0x1c')](_0x32f31d,_0x531df7,_0x4544e7)){_0x3e7bd9(null);}else{_0x31ef91(new Error(_0xd8d8('0x1e')));}});};var derive=exports[_0xd8d8('0x1f')]=function(_0x22235d,_0x5e7a5c){return new Promise(function(_0x59fe25){assert(Buffer[_0xd8d8('0x20')](_0x22235d),_0xd8d8('0x21'));assert(Buffer[_0xd8d8('0x20')](_0x5e7a5c),_0xd8d8('0x22'));assert(_0x22235d['\x6c\x65\x6e\x67\x74\x68']===0x20,_0xd8d8('0x23'));assert(isValidPrivateKey(_0x22235d),'\x42\x61\x64\x20\x70\x72\x69\x76\x61\x74\x65\x20\x6b\x65\x79\x20\x34');assert(_0x5e7a5c[_0xd8d8('0x1')]===0x41||_0x5e7a5c[_0xd8d8('0x1')]===0x21,'\x42\x61\x64\x20\x70\x75\x62\x6c\x69\x63\x20\x6b\x65\x79\x20\x35');if(_0x5e7a5c[_0xd8d8('0x1')]===0x41){assert(_0x5e7a5c[0x0]===0x4,_0xd8d8('0x24'));}if(_0x5e7a5c[_0xd8d8('0x1')]===0x21){assert(_0x5e7a5c[0x0]===0x2||_0x5e7a5c[0x0]===0x3,_0xd8d8('0x25'));}var _0x310b81=ec['\x6b\x65\x79\x46\x72\x6f\x6d\x50\x72\x69\x76\x61\x74\x65'](_0x22235d);var _0x631c7=ec[_0xd8d8('0x26')](_0x5e7a5c);var _0x107436=_0x310b81[_0xd8d8('0x1f')](_0x631c7[_0xd8d8('0x14')]());_0x59fe25(Buffer[_0xd8d8('0x8')](_0x107436[_0xd8d8('0x27')]()));});};exports[_0xd8d8('0x28')]=function(_0x117e99,_0x599fd1,_0x244aac){_0x244aac=_0x244aac||{};var _0x3e1fb0,_0x1feb73,_0x5ee7ef,_0x5638a8;return new Promise(function(_0x6090c0){var _0x5015d3=_0x244aac[_0xd8d8('0x29')]||randomBytes(0x20);while(!isValidPrivateKey(_0x5015d3)){_0x5015d3=_0x244aac['\x65\x70\x68\x65\x6d\x50\x72\x69\x76\x61\x74\x65\x4b\x65\x79']||randomBytes(0x20);}_0x1feb73=getPublic(_0x5015d3);_0x6090c0(derive(_0x5015d3,_0x117e99));})[_0xd8d8('0x2a')](function(_0x3374c2){return sha512(_0x3374c2);})[_0xd8d8('0x2a')](function(_0xc6f0c){_0x3e1fb0=_0x244aac['\x69\x76']||randomBytes(0x10);var _0x3f9d54=_0xc6f0c['\x73\x6c\x69\x63\x65'](0x0,0x20);_0x5638a8=_0xc6f0c[_0xd8d8('0x2b')](0x20);var _0x2de0d6=forge[_0xd8d8('0x5')][_0xd8d8('0x6')](_0x3f9d54);var _0x5c054f=forge['\x63\x69\x70\x68\x65\x72'][_0xd8d8('0x2c')](_0xd8d8('0x2d'),_0x2de0d6);_0x5c054f[_0xd8d8('0x11')]({'\x69\x76':_0x3e1fb0['\x74\x6f\x53\x74\x72\x69\x6e\x67'](_0xd8d8('0xa'))});_0x5c054f[_0xd8d8('0xd')](forge[_0xd8d8('0x5')][_0xd8d8('0x6')](_0x599fd1[_0xd8d8('0xe')](_0xd8d8('0xa'))));_0x5c054f[_0xd8d8('0x2e')]();return Buffer[_0xd8d8('0x8')](_0x5c054f['\x6f\x75\x74\x70\x75\x74'][_0xd8d8('0x2f')],'\x62\x69\x6e\x61\x72\x79');})['\x74\x68\x65\x6e'](function(_0x713a1){_0x5ee7ef=_0x713a1;var _0x3bb2fc=Buffer[_0xd8d8('0x30')]([_0x3e1fb0,_0x1feb73,_0x5ee7ef]);return hmacSha256Sign(_0x5638a8,_0x3bb2fc);})[_0xd8d8('0x2a')](function(_0x1e8bd5){return{'\x69\x76':_0x3e1fb0,'\x65\x70\x68\x65\x6d\x50\x75\x62\x6c\x69\x63\x4b\x65\x79':_0x1feb73,'\x63\x69\x70\x68\x65\x72\x74\x65\x78\x74':_0x5ee7ef,'\x6d\x61\x63':_0x1e8bd5};});};exports['\x64\x65\x63\x72\x79\x70\x74']=function(_0x108638,_0x3b6b8f){var _0x360edd;return derive(_0x108638,_0x3b6b8f[_0xd8d8('0x31')])[_0xd8d8('0x2a')](function(_0x4bd4e0){return sha512(_0x4bd4e0);})[_0xd8d8('0x2a')](function(_0x55b028){_0x360edd=_0x55b028[_0xd8d8('0x2b')](0x0,0x20);var _0x46d5db=_0x55b028[_0xd8d8('0x2b')](0x20);var _0x3ea18a=Buffer[_0xd8d8('0x30')]([_0x3b6b8f['\x69\x76'],_0x3b6b8f[_0xd8d8('0x31')],_0x3b6b8f[_0xd8d8('0x32')]]);return hmacSha256Verify(_0x46d5db,_0x3ea18a,_0x3b6b8f[_0xd8d8('0x33')]);})[_0xd8d8('0x2a')](function(_0x27996d){assert(_0x27996d,'\x42\x61\x64\x20\x4d\x41\x43');var _0x2a51f1=forge[_0xd8d8('0x5')][_0xd8d8('0x6')](_0x360edd);var _0x203b05=forge['\x63\x69\x70\x68\x65\x72'][_0xd8d8('0x34')](_0xd8d8('0x2d'),_0x2a51f1);_0x203b05['\x73\x74\x61\x72\x74']({'\x69\x76':_0x3b6b8f['\x69\x76'][_0xd8d8('0xe')]('\x62\x69\x6e\x61\x72\x79')});_0x203b05['\x75\x70\x64\x61\x74\x65'](forge['\x75\x74\x69\x6c'][_0xd8d8('0x6')](_0x3b6b8f[_0xd8d8('0x32')]['\x74\x6f\x53\x74\x72\x69\x6e\x67']('\x62\x69\x6e\x61\x72\x79')));_0x203b05[_0xd8d8('0x2e')]();return _0x203b05[_0xd8d8('0x35')]['\x74\x6f\x53\x74\x72\x69\x6e\x67']();})[_0xd8d8('0x2a')](function(_0x45c6e9){return Buffer[_0xd8d8('0x8')](_0x45c6e9);});};
